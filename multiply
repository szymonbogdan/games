# ==================== TABLICZKA MNO≈ªENIA (1..3 x 1..10) ====================
# USTAWIENIA ‚Äì mo≈ºesz je zmieniƒá przed grƒÖ:
$Config = [pscustomobject]@{
    MinA        = 1      # najmniejszy pierwszy czynnik
    MaxA        = 3      # najwiƒôkszy pierwszy czynnik (gra do 3)
    MinB        = 1      # najmniejszy drugi czynnik
    MaxB        = 10     # najwiƒôkszy drugi czynnik (do 10)
    Questions   = 15     # ile pyta≈Ñ na gracza
    TimeLimitS  = 12     # limit czasu (sekundy); 0 = bez limitu (polecane dla ISE/VS Code)
    Hints       = $true  # podpowied≈∫ jako suma (np. 3√ó4 = 3+3+3+3)
    BeepOnHit   = $true  # pikniƒôcie przy dobrej odpowiedzi
    BeepOnMiss  = $false # pikniƒôcie przy z≈Çej odpowiedzi
    Colors      = [pscustomobject]@{
        Title   = "Cyan"
        Prompt  = "Yellow"
        Good    = "Green"
        Bad     = "Red"
        Info    = "White"
    }
}

# -------------------- WPROWADZENIE GRACZY --------------------
Clear-Host
Write-Host "=== TABLICZKA MNO≈ªENIA: 1..3 √ó 1..10 ===" -ForegroundColor $Config.Colors.Title
Write-Host "Wpisz imiona graczy oddzielone przecinkami, np.: Julia,Kuba (Enter = gra solo)" -ForegroundColor $Config.Colors.Info
Write-Host -NoNewline "> "
$rawPlayers = Read-Host
$Players = @()
if ([string]::IsNullOrWhiteSpace($rawPlayers)) {
    $Players = @("Gracz")
} else {
    $Players = $rawPlayers -split "\s*,\s*" | Where-Object { $_.Trim() -ne "" }
}
$Scores = @{}
$BestStreak = @{}
foreach ($p in $Players) { $Scores[$p] = 0; $BestStreak[$p] = 0 }

# -------------------- FUNKCJE POMOCNICZE --------------------
$rand = [Random]::new()

function Get-Question([int]$minA,[int]$maxA,[int]$minB,[int]$maxB) {
    $a = $rand.Next($minA, $maxA+1)
    $b = $rand.Next($minB, $maxB+1)
    [pscustomobject]@{ A=$a; B=$b; Ans=$a*$b }
}

# Wej≈õcie kompatybilne z r√≥≈ºnymi hostami:
# - Je≈õli brak "prawdziwej konsoli" lub TimeLimitS = 0 -> u≈ºywa Read-Host (bez limitu)
# - Je≈õli jest prawdziwa konsola i TimeLimitS > 0 -> odczyt z czasem i obs≈ÇugƒÖ Esc
function Read-Answer([int]$timeoutS) {
    # wykryj wsparcie dla konsoli
    $supportsConsole = $true
    try { $null = [Console]::KeyAvailable } catch { $supportsConsole = $false }

    if (-not $supportsConsole -or $timeoutS -le 0) {
        # prosty tryb zgodny z ISE/VS Code
        $line = Read-Host
        return [pscustomobject]@{ Input=$line; TimedOut=$false; Esc=$false; Mode="ReadHost" }
    }

    # tryb z limitem czasu w prawdziwej konsoli
    $deadline = (Get-Date).AddSeconds($timeoutS)
    $buf = ""
    while ($true) {
        if ((Get-Date) -ge $deadline) {
            return [pscustomobject]@{ Input=$buf; TimedOut=$true; Esc=$false; Mode="ConsoleKey" }
        }
        if ([Console]::KeyAvailable) {
            $key = [Console]::ReadKey($true)
            switch ($key.Key) {
                "Escape"   { return [pscustomobject]@{ Input=$null; TimedOut=$false; Esc=$true;  Mode="ConsoleKey" } }
                "Enter"    { Write-Host ""; return [pscustomobject]@{ Input=$buf; TimedOut=$false; Esc=$false; Mode="ConsoleKey" } }
                "Backspace"{ if ($buf.Length -gt 0) { $buf = $buf.Substring(0,$buf.Length-1); Write-Host "`b `b" -NoNewline } }
                default {
                    if ($key.KeyChar -match '^-?\d$') {
                        $buf += $key.KeyChar
                        Write-Host $key.KeyChar -NoNewline
                    }
                }
            }
        } else {
            Start-Sleep -Milliseconds 20
        }
    }
}

function Show-Hint($a,$b) {
    if (-not $Config.Hints) { return }
    $parts = @()
    for ($i=1; $i -le $b; $i++) { $parts += $a }
    $txt = ($parts -join "+")
    Write-Host ("  Podpowied≈∫: {0}√ó{1} = {2}" -f $a,$b,$txt) -ForegroundColor $Config.Colors.Info
}

function Beep($good) {
    try {
        if ($good -and $Config.BeepOnHit)      { [Console]::Beep(1000,120) }
        if (-not $good -and $Config.BeepOnMiss){ [Console]::Beep(300,180)  }
    } catch {}
}

# -------------------- ROZGRYWKA --------------------
foreach ($player in $Players) {
    Clear-Host
    Write-Host ("=== Kolej gracza: {0} ===" -f $player) -ForegroundColor $Config.Colors.Title
    Write-Host ("Masz {0} pyta≈Ñ. Zakres: {1}..{2} √ó {3}..{4}" -f $Config.Questions,$Config.MinA,$Config.MaxA,$Config.MinB,$Config.MaxB) -ForegroundColor $Config.Colors.Info
    if ($Config.TimeLimitS -gt 0) {
        Write-Host ("Limit czasu: {0}s na pytanie. Naci≈õnij Esc, aby przerwaƒá." -f $Config.TimeLimitS) -ForegroundColor $Config.Colors.Info
    } else {
        Write-Host "Brak limitu czasu. Wpisz odpowied≈∫ i naci≈õnij Enter." -ForegroundColor $Config.Colors.Info
    }
    Write-Host ""

    $streak = 0
    for ($q=1; $q -le $Config.Questions; $q++) {
        $task = Get-Question $Config.MinA $Config.MaxA $Config.MinB $Config.MaxB
        Write-Host ("[{0}/{1}]  {2} √ó {3} = ?" -f $q,$Config.Questions,$task.A,$task.B) -ForegroundColor $Config.Colors.Prompt
        Show-Hint $task.A $task.B

        Write-Host -NoNewline "> "
        $res = Read-Answer $Config.TimeLimitS
        if ($res.Esc) { Write-Host "Przerwano turƒô." -ForegroundColor $Config.Colors.Info; break }

        $ok = $false
        if (-not $res.TimedOut -and ($res.Input -match '^-?\d+$')) {
            $ok = ([int]$res.Input -eq $task.Ans)
        }

        if ($ok) {
            $Scores[$player] += 1
            $streak += 1
            if ($streak -gt $BestStreak[$player]) { $BestStreak[$player] = $streak }
            Write-Host ("  ‚úî Dobrze! ({0} √ó {1} = {2})  +1 pkt   [Seria: {3}]" -f $task.A,$task.B,$task.Ans,$streak) -ForegroundColor $Config.Colors.Good
            Beep $true
        } else {
            $streak = 0
            if ($res.TimedOut) {
                Write-Host ("  ‚úñ Czas minƒÖ≈Ç. Poprawna odpowied≈∫: {0}" -f $task.Ans) -ForegroundColor $Config.Colors.Bad
            } else {
                Write-Host ("  ‚úñ Nie. {0} √ó {1} = {2}" -f $task.A,$task.B,$task.Ans) -ForegroundColor $Config.Colors.Bad
            }
            Beep $false
        }
        Start-Sleep -Milliseconds 500
        Write-Host ""
    }
}

# -------------------- PODSUMOWANIE --------------------
Clear-Host
Write-Host "=== WYNIKI ===" -ForegroundColor $Config.Colors.Title
foreach ($p in $Players) {
    Write-Host ("{0,-12}  Punkty: {1,2}   Najlepsza seria: {2}" -f $p,$Scores[$p],$BestStreak[$p]) -ForegroundColor $Config.Colors.Info
}
if ($Players.Count -gt 1) {
    $winner = ($Scores.GetEnumerator() | Sort-Object Value -Descending | Select-Object -First 1).Key
    Write-Host ""
    Write-Host ("üèÜ Wygrywa: {0}!" -f $winner) -ForegroundColor $Config.Colors.Good
}
Write-Host ""
Write-Host "Dziƒôki za grƒô! Zmie≈Ñ parametry w sekcji USTAWIENIA i zagraj ponownie."
# =================================================================
